# Alembic Migration Workflow Guide

This document describes the step-by-step process for creating and managing database migrations using Alembic in the Aslan Drive trading infrastructure.

## Overview

Aslan Drive uses **Alembic** for database schema versioning and migration management. SQLAlchemy models in the `models/` directory serve as the **single source of truth** for database schema.

## Quick Reference

| Command | Purpose |
|---------|---------|
| `alembic revision --autogenerate -m "Description"` | Create new migration |
| `alembic upgrade head` | Apply all pending migrations |
| `alembic current` | Show current database revision |
| `alembic history` | Show migration history |
| `alembic downgrade -1` | Rollback one migration |

## Step-by-Step Migration Workflow

### 1. Modifying Database Schema

When you need to change the database schema:

1. **Edit SQLAlchemy models** in `models/market_data.py`:
   ```python
   # Example: Adding a new column
   class DailyOHLCV(Base):
       # ... existing columns ...
       adjusted_close = Column(Numeric(15, 4), nullable=True, 
                              comment="Adjusted closing price")
   ```

2. **Do NOT directly edit** `alembic/versions/*.py` files manually
3. **Do NOT modify** the database directly with SQL

### 2. Creating an Alembic Migration

After modifying your models, create a migration:

```bash
# Navigate to project root
cd /path/to/aslan_drive

# Create migration with descriptive message
alembic revision --autogenerate -m "Add adjusted_close column to daily_ohlcv"
```

This will:
- Compare your models with current database schema
- Generate a new migration file in `alembic/versions/`
- Include both `upgrade()` and `downgrade()` functions

### 3. Reviewing the Generated Migration

**⚠️ ALWAYS REVIEW** the generated migration file before committing:

```python
# Example generated file: alembic/versions/20250904_2030_add_adjusted_close.py
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('daily_ohlcv', 
                  sa.Column('adjusted_close', sa.Numeric(precision=15, scale=4), 
                           nullable=True, comment='Adjusted closing price'))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('daily_ohlcv', 'adjusted_close')
    # ### end Alembic commands ###
```

**Common Review Points:**
- Verify column types and constraints are correct
- Check if `nullable=False` columns need default values
- Ensure indexes and foreign keys are properly handled
- Validate that downgrade operation is safe

### 4. Testing the Migration

Test your migration locally:

```bash
# Check current database state
alembic current

# Apply the migration
alembic upgrade head

# Verify the changes
alembic current
alembic history
```

**For testing downgrades:**
```bash
# Test rollback (optional but recommended)
alembic downgrade -1
alembic upgrade head
```

### 5. Committing Your Changes

Commit **both** the model changes and migration file:

```bash
# Add both files to git
git add models/market_data.py
git add alembic/versions/20250904_2030_*_add_adjusted_close.py

# Commit with descriptive message
git commit -m "feat: Add adjusted_close column to daily_ohlcv table

- Added adjusted_close field to DailyOHLCV model
- Generated Alembic migration for schema update
- Migration ID: 20250904_2030_add_adjusted_close"
```

## Production Deployment

### Automated Deployment (Recommended)

Migrations run automatically during the **DB backup process**:

1. **Pre-backup**: `alembic upgrade head` runs before database backup
2. **Backup**: Standard PostgreSQL dump
3. **Post-backup**: Additional backup after migration verification

### Manual Deployment

If you need to run migrations manually:

```bash
# Using the migration service
kubectl run migration-job --image=ghcr.io/jsam0418/aslan_drive/db-migration:latest \
  --env="DATABASE_URL=$DB_URL" --env="MIGRATION_COMMAND=upgrade" \
  --restart=Never --namespace=aslan-drive

# Or directly with kubectl exec
kubectl exec -it deployment/aslan-postgres -n aslan-drive -- \
  alembic upgrade head
```

## Common Scenarios

### Adding a New Table

1. Create new model class in `models/market_data.py`
2. Update `models/__init__.py` to import the new model
3. Generate migration: `alembic revision --autogenerate -m "Add new_table"`
4. Review and commit

### Modifying Column Types

```python
# Before
volume = Column(BigInteger, nullable=False)

# After  
volume = Column(Numeric(20, 2), nullable=False)  # More precision
```

**⚠️ Important:** Review data conversion carefully in migration file.

### Adding Indexes

```python
# In your model
class DailyOHLCV(Base):
    # ... columns ...
    
    __table_args__ = (
        Index('idx_daily_ohlcv_symbol_date', 'symbol', 'date'),
        Index('idx_daily_ohlcv_date', 'date'),
    )
```

### Renaming Columns

Alembic may not detect column renames correctly. You may need to manually edit:

```python
def upgrade() -> None:
    # Rename column
    op.alter_column('daily_ohlcv', 'old_column_name', 
                    new_column_name='new_column_name')

def downgrade() -> None:
    # Reverse the rename
    op.alter_column('daily_ohlcv', 'new_column_name', 
                    new_column_name='old_column_name')
```

## Troubleshooting

### "Target database is not up to date"

```bash
# Check current revision
alembic current

# Check what migrations exist
alembic history

# If database is behind, upgrade
alembic upgrade head
```

### "Can't locate revision identified by 'xxx'"

This usually means migration files are missing:

```bash
# Check what migration files exist
ls alembic/versions/

# If missing files, restore from git or regenerate
git checkout HEAD -- alembic/versions/
```

### Schema Drift Detection

The CI/CD pipeline automatically detects when model changes exist without corresponding migrations:

```bash
# Locally check for drift
alembic check

# If drift detected, create migration
alembic revision --autogenerate -m "Fix schema drift"
```

### Rolling Back Migrations

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade abc123

# Rollback to base (⚠️ DANGEROUS - drops all tables)
alembic downgrade base
```

## CI/CD Integration

The CI/CD pipeline includes several migration-related checks:

1. **Model Validation**: Ensures SQLAlchemy models can be imported
2. **Schema Drift Detection**: Fails if models changed without migration
3. **Integration Tests**: Runs migrations against test database
4. **Docker Builds**: Includes migration service in build matrix

### CI/CD Failure: "Schema changes detected"

If CI fails with schema change detection:

1. Run locally: `alembic revision --autogenerate -m "Description"`
2. Review the generated migration
3. Commit both model and migration files
4. Push to trigger CI again

## Best Practices

### ✅ Do

- Always review generated migrations before committing
- Use descriptive migration messages
- Test migrations locally before pushing
- Backup production data before major schema changes
- Keep migrations small and focused
- Document complex migration logic

### ❌ Don't

- Edit migration files manually unless necessary
- Skip migration generation after model changes
- Delete migration files from version control
- Run direct SQL on production without migrations
- Create migrations for temporary/development changes

## Migration File Naming Convention

Alembic uses this naming pattern:
```
YYYYMMDD_HHMM_{revision_id}_{slug}.py
20250904_2030_abc123def_add_adjusted_close_column.py
```

- `YYYYMMDD_HHMM`: Timestamp when migration was created
- `{revision_id}`: Short hash identifier
- `{slug}`: URL-safe version of migration message

## Database Connection Configuration

Alembic reads database configuration from:

1. **Environment variable**: `DATABASE_URL` (highest priority)
2. **alembic.ini file**: `sqlalchemy.url` setting
3. **Default**: Development database URL

Production deployments always use the environment variable approach.

## Getting Help

- **Alembic Documentation**: https://alembic.sqlalchemy.org/
- **SQLAlchemy Documentation**: https://docs.sqlalchemy.org/
- **Team Migration Guide**: This document
- **Local Testing**: Use `make dev-setup && source venv/bin/activate`

## Examples

### Complete Example: Adding a New Column

```bash
# 1. Edit models/market_data.py
# Add: sentiment_score = Column(Numeric(3, 2), nullable=True)

# 2. Generate migration
alembic revision --autogenerate -m "Add sentiment_score to daily_ohlcv"

# 3. Review generated file in alembic/versions/

# 4. Test locally
alembic upgrade head

# 5. Commit both files
git add models/market_data.py alembic/versions/*sentiment_score*
git commit -m "feat: Add sentiment_score column for market sentiment tracking"

# 6. Push and let CI/CD handle the rest
git push origin feature/add-sentiment-score
```

This workflow ensures consistent, safe, and trackable database schema evolution across all environments.